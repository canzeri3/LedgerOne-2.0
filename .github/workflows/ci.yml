name: CI - Contract Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      # Make Next.js quieter and deterministic in CI
      NODE_ENV: production
      NEXT_TELEMETRY_DISABLED: "1"

      # Your app expects these at runtime
      NEXT_PUBLIC_DATA_CORE: new
      DATA_CORE_DEFAULT: new
      INTERNAL_BASE_URL: "http://localhost:3000"

      # Reduce external calls during tests (ok: tests only assert shape)
      DISABLE_24H: "1"

      # Providers: use your repo secret (add in GitHub → Settings → Secrets → Actions)
      CG_API_KEY: ${{ secrets.CG_API_KEY }}

      # Optional: if your server code needs it; otherwise omit
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      # Tests hit the local server we start below
      TEST_HOST: "http://localhost:3000"

    steps:
      - name: Checkout
      # v4 of checkout (stable)
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install deps (clean)
        run: npm ci

      - name: Build Next.js
        run: npm run build

      - name: Start server (background)
        run: |
          # Start Next on 3000 in the background
          nohup npm run start >/dev/null 2>&1 &
          # Wait for it to come up
          npx wait-on http://localhost:3000

      - name: Run contract tests
        run: npm test

      - name: Print minimal logs on failure
        if: failure()
        run: |
          echo "Tests failed. Printing last Next logs (if any)."
          # Nothing special to cat here since we ran with nohup to background;
          # Your routes log to stdout; GitHub captures step logs automatically.

